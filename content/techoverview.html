<h2>ElCamino.AspNetCore.Identity.AzureTable &lt;= 1.7</h2>
<h3>High Level Dependencies</h3>
<img src="images/AzureIdentityTableDependency.png" alt="AzureIdentityTableDependency.png" title="AzureIdentityTableDependency.png">
<br>
ElCamino.AspNet.Identity.AzureTable.dll acts as the data access layer under the Microsoft.AspNet.Identity.Core.dll classes UserManager and RoleManager by implementing the necessary interfaces on the UserStore and RoleStore respectively. These classes consume
 the <a href="https://github.com/dlmelendez/identityazuretable/tree/master/src/ElCamino.AspNetCore.Identity.AzureTable/IdentityCloudContext.cs">
    IdentityCloudContext
</a> and the other Identity Model classes described below to persist the user and role information according to the business logic dictated by the respective UserManager and RoleManager classes.
<h3>UserStore and RoleStore Classes</h3>
<img src="images/IdentityUserStoreRoleStore.png" alt="IdentityUserStoreRoleStore.png" title="IdentityUserStoreRoleStore.png">
<h3>IdentityCloudContext and Connections</h3>
<a href="https://github.com/dlmelendez/identityazuretable/tree/master/src/ElCamino.AspNetCore.Identity.AzureTable/IdentityCloudContext.cs">IdentityCloudContext</a> that enables access to the Azure Table storage service and exposes the tables.
<br>
The IdentityCloudContext default constructor will look for the IdentityConfigurationSection in the app or web.config which is
<b>new in version 1.2.9.0</b>. If this configuration section is not found, the storage connection string under the AppSettings key &quot;StorageConnectionString&quot; which is a deprecated option that will be phased out in lieu of the configuration section
 or the new IdentityCloudContext(IdentityConfiguration config) overload. The new IdentityConfiguration class is Json serializable for ease of loading/saving these settings.
<br>
<b>New in 1.2.9.0</b> - use the new TablePrefix property to set a naming prefix for the azure tables that are using in the storage account. This enables multi-tenant support per storage account via configuration option for table name prefixing. e.g. Table prefix
 &#39;My&#39; uses tables, MyAspNetIndex, MyAspNetRoles, MyAspNetUsers. This is an optional field, can be set to string.empty or left unset.
<br>
Example of using the new configuration section:
<br>
<div style="color:Black; background-color:White">
<pre>
    <span style="color:Blue">&lt;</span><span style="color:#A31515">configSections</span><span style="color:Blue">&gt;</span>
    <span style="color:Blue">&lt;</span><span style="color:#A31515">section</span> <span style="color:Red">name</span><span style="color:Blue">=</span><span style="color:Black">&quot;</span><span style="color:Blue">elcaminoIdentityConfiguration</span><span style="color:Black">&quot;</span> <span style="color:Red">type</span><span style="color:Blue">=</span><span style="color:Black">&quot;</span><span style="color:Blue">ElCamino.AspNet.Identity.AzureTable.Configuration.IdentityConfigurationSection,ElCamino.AspNet.Identity.AzureTable </span><span style="color:Black">&quot;</span> <span style="color:Blue">/&gt;</span>
    <span style="color:Blue">&lt;/</span><span style="color:#A31515">configSections</span><span style="color:Blue">&gt;</span>
    <span style="color:Blue">&lt;</span><span style="color:#A31515">elcaminoIdentityConfiguration</span> <span style="color:Red">tablePrefix</span><span style="color:Blue">=</span><span style="color:Black">&quot;</span><span style="color:Blue">&quot; storageConnectionString=&quot;UseDevelopmentStorage=true</span><span style="color:Black">&quot;</span> <span style="color:Blue">/&gt;</span>
...
</pre>
</div>
<br>
<b>Note: the following appSettings configuration option has been deprecated in 1.2.9.0.</b>
<del>A custom AppSettings key can be passed in the overloaded constructor IdentityCloudContext(string appSettingsKey). If the appSettingsKey is not found, the literal string will be assumed to be the connection string.</del>
<br>
For example, the default local connection string to the Azure Storage Emulator.
<br>
<div style="color:Black; background-color:White">
<pre>
<span style="color:Blue">&lt;</span><span style="color:#A31515">configuration</span><span style="color:Blue">&gt;</span>
    <span style="color:Blue">&lt;</span><span style="color:#A31515">appSettings</span><span style="color:Blue">&gt;</span>
    ...
    <span style="color:Blue">&lt;</span><span style="color:#A31515">add</span> <span style="color:Red">key</span><span style="color:Blue">=</span><span style="color:Black">&quot;</span><span style="color:Blue">StorageConnectionString</span><span style="color:Black">&quot;</span> <span style="color:Red">value</span><span style="color:Blue">=</span><span style="color:Black">&quot;</span><span style="color:Blue">UseDevelopmentStorage=true</span><span style="color:Black">&quot;</span> <span style="color:Blue">/&gt;</span>
</pre>
</div>
<h3>Identity Model to Azure Table Relationships</h3>
<img src="images/IdentityModelToAzureTable.png" alt="IdentityModelToAzureTable.png" title="IdentityModelToAzureTable.png">
<h4>AspNetUsers</h4>
<table>
    <tbody>
        <tr>
            <th>Identity Model </th>
            <th>PartitionKey </th>
            <th>RowKey </th>
            <th>Cardinality</th>
        </tr>
        <tr>
            <td>
                <a href="https://github.com/dlmelendez/identityazuretable/tree/master/src/ElCamino.AspNetCore.Identity.AzureTable/Model/IdentityUser.cs">IdentityUser</a>
            </td>
            <td>Escaped(UserName) </td>
            <td>Escaped(UserName) </td>
            <td>1 per user</td>
        </tr>
        <tr>
            <td>
                <a href="https://github.com/dlmelendez/identityazuretable/tree/master/src/ElCamino.AspNetCore.Identity.AzureTable/Model/IdentityUserClaim.cs">IdentityUserClaim</a>
            </td>
            <td>Escaped(UserName) </td>
            <td>Escaped(ClaimType, ClaimValue) </td>
            <td>0 to Many per user</td>
        </tr>
        <tr>
            <td>
                <a href="https://github.com/dlmelendez/identityazuretable/tree/master/src/ElCamino.AspNetCore.Identity.AzureTable/Model/IdentityUserLogin.cs">IdentityUserLogin</a>
            </td>
            <td>Escaped(UserName) </td>
            <td>Escaped(LoginProvider, ProviderKey) </td>
            <td>0 to Many per user</td>
        </tr>
        <tr>
            <td>
                <a href="https://github.com/dlmelendez/identityazuretable/tree/master/src/ElCamino.AspNetCore.Identity.AzureTable/Model/IdentityUserRole.cs">IdentityUserRole</a>
            </td>
            <td>Escaped(UserName) </td>
            <td>Escaped(RoleName) </td>
            <td>0 to Many per user</td>
        </tr>
    </tbody>
</table>
<h4>AspNetIndex</h4>
<table>
    <tbody>
        <tr>
            <th>Identity Model </th>
            <th>Type </th>
            <th>PartitionKey </th>
            <th>RowKey </th>
            <th>Id </th>
            <th>Cardinality</th>
        </tr>
        <tr>
            <td>
                <a href="https://github.com/dlmelendez/identityazuretable/tree/master/src/ElCamino.AspNetCore.Identity.AzureTable/Model/IdentityUserIndex.cs">IdentityUserIndex</a>
            </td>
            <td>User Email Index </td>
            <td>Escaped(User Email) </td>
            <td>Escaped(UserName) </td>
            <td>Escaped(UserName) </td>
            <td>0 or 1 per user</td>
        </tr>
        <tr>
            <td><a href="https://github.com/dlmelendez/identityazuretable/tree/master/src/ElCamino.AspNetCore.Identity.AzureTable/Model/IdentityUserIndex.cs">IdentityUserIndex</a></td>
            <td>User Login Index </td>
            <td>Escaped(LoginProvider, ProviderKey) </td>
            <td>Escaped(LoginProvider, ProviderKey) </td>
            <td>Escaped(UserName) </td>
            <td>0 to Many per user</td>
        </tr>
    </tbody>
</table>
<h4>AspNetRoles</h4>
<table>
    <tbody>
        <tr>
            <th>Identity Model </th>
            <th>PartitionKey </th>
            <th>RowKey</th>
        </tr>
        <tr>
            <td>
                <a href="https://github.com/dlmelendez/identityazuretable/tree/master/src/ElCamino.AspNetCore.Identity.AzureTable/Model/IdentityRole.cs">IdentityRole</a>
            </td>
            <td>Escaped(First Char of RoleName) </td>
            <td>Escaped(RoleName)</td>
        </tr>
    </tbody>
</table>
<br>
<br>
The properties of the respective identity model class are stored as a field in the table unless marked with the ignore attribute. Inheriting and extending these classes one can add fields whenever your extended class is saved. Also, the Escaped() psydo-code
 is a reference to the respective methods found in the <a href="https://github.com/dlmelendez/identityazuretable/tree/master/src/ElCamino.AspNetCore.Identity.AzureTable/Helpers/KeyHelper.cs">
    KeyHelper
</a> class.
<h3>Performance </h3>
The AspNetUsers table is designed to keep all of the user&#39;s data in a single table and in a table partition for each user. This results in a single query using the user&#39;s id (partition key) to get all of the data in a single query when the user&#39;s
 id is known. The user&#39;s id is an &#39;Escaped&#39; version of the username and the traditional guid is not used. This makes the UserStore.FindByUserNameAsync() and UserStoreFindByUserNameAsync() use the same query. When the user id is not known, the AspNetIndex
 table is queried first either by user&#39;s email UserStore.FindByEmailAsync() or external login information UserStore.FindAsync() to get the user&#39;s id to then query by user id for the complete user information. The AspNextIndex is always queried by partition
 and rowkey making that query extremely fast. See above for the details of the AspNetIndex partition and rowkey strategy.
<br>
AspNetRoles table also uses a composite of the RoleName for the partition and row keys making it possible query the table by its primary key optimizing performance.
<h3>Testing </h3>
A full suite of integration tests against this assembly <a href="https://github.com/dlmelendez/identityazuretable/blob/master/tests/ElCamino.AspNet.Identity.AzureTable.Tests/ElCamino.AspNet.Identity.AzureTable.Tests.csproj">
    ElCamino.AspNet.Identity.AzureTable.Tests.csproj
</a>
<h3>Release Management</h3>
<ul>
    <li>
        Full suite of integration tests against this assembly at 100% pass rate against the Azure Local Emulator and against a live Azure Storage account. 100% pass rate is required before release. The tests are at about 99% code coverage currently and will work to keep
        the up.
    </li>
    <li>
        Releases available on NuGet and are strong name signed. Binaries are available for download from this site.
    </li>
    <li><a href="https://www.nuget.org/packages/ElCamino.AspNet.Identity.AzureTable/">https://www.nuget.org/packages/ElCamino.AspNet.Identity.AzureTable/</a></li>
    <li><a href="https://www.nuget.org/packages/ElCamino.AspNetCore.Identity.AzureTable/">https://www.nuget.org/packages/ElCamino.AspNetCore.Identity.AzureTable/</a></li>

</ul>
</div>
<div></div>

