<div>
    <h1>ElCamino.AspNetCore.Identity.AzureTable </h1>
<h2><a href="https://github.com/dlmelendez/identityazuretable/tree/master/sample/samplemvccore2">Sample Mvc6 (.NET Core 2) Website</a></h2>
    Included in the source is a MVC 6 Website project that is an example of removing the EntityFramework and Identity EntityFramework references and replacing them with the Azure Table storage provider. <br>
    <h2>Overview</h2>
    The sample Mvc web application is a standard web application that uses the Individual User Accounts authentication type. The EntityFramework references have been removed and replaced with the Azure Table storage provider.<br>
    <h2>Walk-Through of the samplemvccore2</h2>
    Remove the NuGet packages EntityFramework and Microsoft.AspNetCore.Identity.EntityFramework packages using the Manage NuGet Packages.<br>
    Remove this using statement throughout the application.<br>
    <del>using Microsoft.AspNetCore.Identity.EntityFramework;</del><br>
    Add the NuGet package or the assembly ElCamino.AspNetCore.Identity.AzureTable to the web application.
    <h3>Simplify project references</h3>
    <pre><code class="xml language-xml">&lt;ItemGroup&gt;
    &lt;PackageReference Include="ElCamino.AspNetCore.Identity.AzureTable" Version="2.0.0" /&gt;
    &lt;PackageReference Include="Microsoft.AspNetCore" Version="2.0.0" /&gt;
    &lt;PackageReference Include="Microsoft.AspNetCore.Authentication.Cookies" Version="2.0.0" /&gt;
    &lt;PackageReference Include="Microsoft.AspNetCore.Mvc" Version="2.0.0" /&gt;
    &lt;PackageReference Include="Microsoft.AspNetCore.Mvc.Razor.ViewCompilation" Version="2.0.0" PrivateAssets="All" /&gt;
    &lt;PackageReference Include="Microsoft.AspNetCore.StaticFiles" Version="2.0.0" /&gt;
    &lt;PackageReference Include="Microsoft.VisualStudio.Web.BrowserLink" Version="2.0.0" /&gt;
    &lt;PackageReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Design" Version="2.0.0" PrivateAssets="All" /&gt;
  &lt;/ItemGroup&gt;

  &lt;ItemGroup&gt;
    &lt;DotNetCliToolReference Include="Microsoft.Extensions.SecretManager.Tools" Version="2.0.0" /&gt;
    &lt;DotNetCliToolReference Include="Microsoft.VisualStudio.Web.CodeGeneration.Tools" Version="2.0.0" /&gt;
  &lt;/ItemGroup&gt;
</code></pre>
    <h3>
        Changes to <a href="https://github.com/dlmelendez/identityazuretable/blob/master/sample/samplemvccore2/Models/ApplicationUser.cs">
            /sample/samplemvccore2/Models/ApplicationUser.cs
        </a>
    </h3>
    Replace the statement<br>
    <del>using Microsoft.AspNetCore.Identity.EntityFramework;</del><br>
    <del>using Microsoft.AspNetCore.Identity;</del><br>
    with:<br>
    <div style="color:Black; background-color:White">
<pre>
<span style="color:Blue">using</span> ElCamino.AspNetCore.Identity.AzureTable.Model;
</pre>
    </div>
    ...<br>
    Inherit from the IdentityUser class to provide the base user information and Azure Table Row and Partition Key mappings.<br>
    <div style="color:Black; background-color:White">
<pre>
        <span style="color:Green">// You can add profile data for the user by adding more properties to your ApplicationUser class, please visit http://go.microsoft.com/fwlink/?LinkID=317594 to learn more.</span>
        <span style="color:Blue">public</span> <span style="color:Blue">class</span> ApplicationUser : IdentityUser
    { ...
</pre>
    </div>
    ...<br>
    <h3>
        Changes to <a href="https://github.com/dlmelendez/identityazuretable/blob/master/sample/samplemvccore2/Data/ApplicationDbContext.cs">
            /sample/samplemvccore2/Data/ApplicationDbContext.cs
        </a>
    </h3>
    Replace the statement<br>
    <del>using Microsoft.AspNetCore.Identity.EntityFramework;</del><br>
    with:<br>
    <div style="color:Black; background-color:White">
<pre>
<span style="color:Blue">using</span> ElCamino.AspNetCore.Identity.AzureTable;
<span style="color:Blue">using</span> ElCamino.AspNetCore.Identity.AzureTable.Model;
</pre>
        </div>
        Inherit from the IdentityCloudContext which provides the Azure connection and table storage schema.<br>
        <div style="color:Black; background-color:White">
<pre>
            <span style="color:Blue">public</span> <span style="color:Blue">class</span> ApplicationDbContext : IdentityCloudContext
    {
            <span style="color:Blue">public</span> ApplicationDbContext() : <span style="color:Blue">base</span>() { } 
            <span style="color:Blue">public</span> ApplicationDbContext(IdentityConfiguration config) : base(config) { }...
</pre>
        </div>
        <h3>
            Changes to <a href="https://github.com/dlmelendez/identityazuretable/blob/master/sample/samplemvccore2/Startup.cs">
                /sample/samplemvccore2/Startup.cs
            </a>
        </h3>
        Replace the statement<br>
        <del>using Microsoft.AspNetCore.Identity.EntityFramework;</del><br>
        with:<br>
        <div style="color:Black; background-color:White">
<pre>
<span style="color:Blue">using</span> ElCamino.AspNetCore.Identity.AzureTable;
<span style="color:Blue">using</span> ElCamino.AspNetCore.Identity.AzureTable.Model;
</pre>
        </div>
        ...<br>
        Adding code to inject the Azure table provider into the Identity middleware pipeline and optionally, create the azure tables. Remove any EntityFramework extension methods here.<br>
        <div style="color:Black; background-color:White">
            <pre>
    <span style="color:Blue">public</span> <span style="color:Blue">class</span> Startup 
    {
        ...
    <span style="color:Blue">public</span> <span style="color:Blue">void</span> ConfigureServices(IServiceCollection services)
    {
        <span style="color:green">// Add Elcamino Azure Table Identity services.</span>
        services.AddIdentity<ApplicationUser, IdentityRole>()
            .AddAzureTableStores<ApplicationDbContext>(new Func<IdentityConfiguration>(() =&gt;
            {
                IdentityConfiguration idconfig = new IdentityConfiguration();
                idconfig.TablePrefix = Configuration.GetSection("IdentityAzureTable:IdentityConfiguration:TablePrefix").Value;
                idconfig.StorageConnectionString = Configuration.GetSection("IdentityAzureTable:IdentityConfiguration:StorageConnectionString").Value;
                idconfig.LocationMode = Configuration.GetSection("IdentityAzureTable:IdentityConfiguration:LocationMode").Value;
                return idconfig;
            }))
            .AddDefaultTokenProviders()
            .CreateAzureTablesIfNotExists<ApplicationDbContext>(); //can remove after first run;
        services.AddMvc();
        <span style="color:green">// Add application services</span>
        
...
</pre>
        </div>
        <h3>
            Changes to <a href="https://github.com/dlmelendez/identityazuretable/blob/master/sample/samplemvccore2/appsettings.json">
                /sample/samplemvccore2/appsettings.json
            </a>
        </h3>
        Remove all references to the EntityFramework.<br>
        Add the default local connection string to the Azure Storage Emulator in the appsettings.json.
        TablePrefix can be left blank, any text here will prefix the Azure table storage names.
        StorageConnectionString is the Azure table storage connection string.
        LocationMode can be left empty (defaults to PrimaryOnly). Other storage location modes are listed <a href="https://msdn.microsoft.com/en-us/library/azure/microsoft.windowsazure.storage.retrypolicies.locationmode.aspx">here</a> and must be used with a RA-GRS storage account if changed from the default.
        <br>
        <div style="color:Black; background-color:White">
<pre>
{
...
    "IdentityAzureTable": {
        "IdentityConfiguration": {
            "TablePrefix": <span style="color:#A31515">"mvc6"</span>
            "StorageConnectionString": <span style="color:#A31515">"UseDevelopmentStorage=true;"</span>
            "LocationMode": <span style="color:#A31515">"PrimaryOnly"</span>
        }
    }...
}
</pre>
        </div>
        <br>
        <h3>Tip: Don&#39;t forget to start your Azure Storage Emulator if running locally.</h3>
    </div>
<div></div>
